{% extends './base.html' %}

{% block title %}Detalles del Grupo{% endblock %}

{% block body %}
<h2>Detalles del Grupo</h2>

{% if grupo %}
    <p>Grupo: {{ grupo.nombre_grupo }}</p>
    <p>Carrera: {{ grupo.carrera }}</p>

    <h3>Calificar el grupo:</h3>
    {% if alumnos %}
    <form action="{{ url_for('grupo_detalle', id_grupo=grupo.id_grupo) }}" method="post">
        <input type="hidden" value="{{ csrf_token() }}">
        <select name="parcial" required>
            <option value="Parcial 1">Parcial 1</option>
            <option value="Parcial 2">Parcial 2</option>
            <option value="Parcial 3">Parcial 3</option>
        </select>
        <table>
            <thead>
                <tr>
                    <th>Matrícula</th>
                    <th>Nombre</th>
                    <th>HACER</th>
                    <th>SABER</th>
                    <th>SER</th>
                    <th>Calificación</th>
                    <th>Faltas</th>
                </tr>
            </thead>
            <tbody>
                {% for alumno in alumnos %}
                <tr>
                    <td>{{alumno.matricula}}</td>
                    <td>{{ alumno.nombre }} {{ alumno.apellido }} {{alumno.segundo_apellido}}</td>
                    <td><input class="input-box" type="number" step="0.1" min="0" max="100" maxlength="3" value="0" id="hacer_{{alumno.matricula}}" name="hacer_{{alumno.matricula}}" required></td>
                    <td><input class="input-box" type="number" step="0.1" min="0" max="100" maxlength="3" value="0" id="saber_{{alumno.matricula}}" name="saber_{{alumno.matricula}}" required></td>
                    <td><input class="input-box" type="number" step="0.1" min="0" max="100" maxlength="3" value="0" id="ser_{{alumno.matricula}}" name="ser_{{alumno.matricula}}" required></td>
                    <td><label id="calificacion_{{alumno.matricula}}">0</label></td>
                    <input type="hidden" name="id_alumno_{{ alumno.matricula }}" value="{{ alumno.id_alumno }}">
                    <input type="hidden" name="id_materia" value="{{grupo.id_materia}}">
                    <td><input type="number" class="input-box" min="0" value="0" id="faltas_{{alumno.matricula}}" name="faltas_{{alumno.matricula}}" required></td>
                </tr>
                {% endfor %}
                <input type="hidden" name="id_materia" value="{{grupo.id_materia}}">

            </tbody>
        </table>
        <input type="submit" value="Guardar calificaciones">
    </form>
    {% else %}
        <p>No hay alumnos en este grupo.</p>
    {% endif %}
{% else %}
    <p>No se encontró información del grupo.</p>
{% endif %}

<a class="btn btn-secondary" href="{{ url_for('maestro') }}">Volver a la lista de grupos</a>
{% endblock %}
{% block customCSS %}
<style>
    .table-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    table {
        border-collapse: collapse;
        width: 80%;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
</style>
{% endblock %}
{% block customJS %}
<script>
function calcularCalificacion(row) {
    const hacerInput = row.querySelector('input[id^="hacer_"]');
    const saberInput = row.querySelector('input[id^="saber_"]');
    const serInput = row.querySelector('input[id^="ser_"]');
    
    let hacer = parseFloat(hacerInput.value) || 0;
    let saber = parseFloat(saberInput.value) || 0;
    let ser = parseFloat(serInput.value) || 0;
    
    if (hacer > 100) {
        hacer = 100;
        hacerInput.value = 100;
    }
    if (saber > 100) {
        saber = 100;
        saberInput.value = 100;
    }
    if (ser > 100) {
        ser = 100;
        serInput.value = 100;
    }

    const calificacion = (hacer * 0.6 + saber * 0.3 + ser * 0.1).toFixed(2);
    
    const calificacionLabel = row.querySelector('label[id^="calificacion_"]');
    if (calificacionLabel) {
        calificacionLabel.textContent = calificacion;
    }
    
    console.log(`Calificación actualizada: ${calificacion}`);
}

document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="number"][id^="hacer_"], input[type="number"][id^="saber_"], input[type="number"][id^="ser_"]');
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            calcularCalificacion(this.closest('tr'));
        });
    });
});

</script>
{% endblock %}